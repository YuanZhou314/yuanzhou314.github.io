

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/zz.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="小周">
  <meta name="keywords" content="">
  
    <meta name="description" content="数据库的三种连接算法 1、Nested Loop Join 2层循环连接，外层循环逐行检索内层循环的每一行。最基础的连接方式，表比较小且被驱动表有索引的情况下，效率很高。无索引or表较大时性能急剧下降。 2、Hash Join 分2个阶段：  构建：选取表较小者基于连接字段在内存中构建一个哈希表 探测：遍历较大表(探测表)，对其每行的连接字段应用同样的哈希函数，快速定位到哈希表中对应位置，">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL笔记">
<meta property="og:url" content="https://zhouyinglin.top/post/92053909.html">
<meta property="og:site_name" content="小周的院子">
<meta property="og:description" content="数据库的三种连接算法 1、Nested Loop Join 2层循环连接，外层循环逐行检索内层循环的每一行。最基础的连接方式，表比较小且被驱动表有索引的情况下，效率很高。无索引or表较大时性能急剧下降。 2、Hash Join 分2个阶段：  构建：选取表较小者基于连接字段在内存中构建一个哈希表 探测：遍历较大表(探测表)，对其每行的连接字段应用同样的哈希函数，快速定位到哈希表中对应位置，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202512121409105.png">
<meta property="article:published_time" content="2025-12-12T06:00:00.000Z">
<meta property="article:modified_time" content="2025-12-12T06:18:17.964Z">
<meta property="article:author" content="小周">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202512121409105.png">
  
  
  
    <meta name="baidu-site-verification" content="code-bMcoZ9RRBp" />
  
  <title>PostgreSQL笔记 - 小周的院子</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zhouyinglin.top","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"DOFm5rBfeIBUxN13vhiXlS4S-MdYXbMMI","app_key":"FJKOtk5nWqYzGoXXiFAvHIDC","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>小周的院子</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>
    
    <!-- 添加zyl天气 -->

<div id="tp-weather-widget"></div>
    <script>
        (function (a, h, g, f, e, d, c, b) { b = function () { d = h.createElement(g); c = h.getElementsByTagName(g)[0]; d.src = e; d.charset = "utf-8"; d.async = 1; c.parentNode.insertBefore(d, c) }; a["SeniverseWeatherWidgetObject"] = f; a[f] || (a[f] = function () { (a[f].q = a[f].q || []).push(arguments) }); a[f].l = +new Date(); if (a.attachEvent) { a.attachEvent("onload", b) } else { a.addEventListener("load", b, false) } }(window, document, "script", "SeniverseWeatherWidget", "//cdn.sencdn.com/widget2/static/js/bundle.js?t=" + parseInt((new Date().getTime() / 100000000).toString(), 10)));
        window.SeniverseWeatherWidget('show', {
            flavor: "slim",
            location: "WKJ1F428HH2F",
            geolocation: true,
            language: "zh-Hans",
            unit: "c",
            theme: "auto",
            token: "5089001e-aa9f-41c5-862d-e416aabf81f7",
            hover: "enabled",
            container: "tp-weather-widget"
        })
    </script>



    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-books"></i>
                文章
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/archives/">
                    <i class="iconfont icon-archive-fill"></i>
                    归档
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/categories/">
                    <i class="iconfont icon-category-fill"></i>
                    分类
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/tags/">
                    <i class="iconfont icon-tags-fill"></i>
                    标签
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/boxs/">
                <i class="iconfont icon-switch-fill"></i>
                百宝箱
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html">
                <i class="iconfont icon-rss"></i>
                虫洞
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://blog-cnd-1307088890.cos.ap-guangzhou.myqcloud.com/202212161220542.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PostgreSQL笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-12 14:00" pubdate>
          2025年12月12日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          115 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">PostgreSQL笔记</h1>
            
            
              <div class="markdown-body">
                
                <span id="more"></span>
<!-- categories:Dev、Ops、Study、Sth、News、work-->
<!-- tags: 
Python、MySQL、LeetCode、机器学习、Linux、Big Data、Java、BlockChain、Docker、Web 、分布式、
Maven、数据结构、JVM、JavaScript、Crontab、Shell、Ubuntu、VPN、NodeJS、String、VM、Hadoop、
Life、树莓派、Git、Hexo、算法、运维、网络、看法、电影、美学、写作、哲学、文档、绘画、前端、
历史、政治、社会、导购
 -->
<h2 id="数据库的三种连接算法"><a class="markdownIt-Anchor" href="#数据库的三种连接算法"></a> 数据库的三种连接算法</h2>
<p>1、Nested Loop Join</p>
<p>2层循环连接，外层循环逐行检索内层循环的每一行。最基础的连接方式，表比较小且被驱动表有索引的情况下，效率很高。无索引or表较大时性能急剧下降。</p>
<p>2、Hash Join</p>
<p>分2个阶段：</p>
<ul>
<li>构建：选取表较小者基于连接字段在内存中构建一个哈希表</li>
<li>探测：遍历较大表(探测表)，对其每行的连接字段应用同样的哈希函数，快速定位到哈希表中对应位置，找到匹配的行。</li>
</ul>
<p>特征：适合大表等值连接、无需索引，但需要额外内存来建构哈希表</p>
<p>3、Sort Megre Join</p>
<p>分2个阶段：</p>
<ul>
<li>排序：将2个表各自按照连接字段进行排序</li>
<li>合并：像合并2个有序链表一样，同时遍历2个已排序的结果集，一次性找到所有匹配行</li>
</ul>
<p>特点：当连接条件是非等值连接时，或已预先排序，可能比Hash Join更有效。排序本身可能需要消耗大量资源。</p>
<h2 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型"></a> 数据类型</h2>
<ul>
<li>
<p>布尔类型：支持标准boolean类型.</p>
</li>
<li>
<ul>
<li>值可以是true/false、true/false、yes/no、t/f、0/1。</li>
<li>逻辑操作符：AND、OR、NOT</li>
</ul>
</li>
<li>
<p>数值类型</p>
</li>
<li>
<ul>
<li>smallint 2字节</li>
<li>int 4字节</li>
<li>bigint 8字节</li>
<li>real 4字节浮点，不精确、变精度</li>
<li>doulbe precision 8字节浮点数，不精确、变精度</li>
<li>money 8字节，货币类型，保证精度，不通国家精度不一致</li>
</ul>
</li>
<li>
<p>字符类型</p>
</li>
<li>
<ul>
<li>varchar （character varying）变长，最大1G，存储空间：4 + 实际字符串长度</li>
<li>char (character) 定长，不足则补空白，最大1G，存储空间也是4 + n</li>
<li>text 变长，无限制长度。</li>
</ul>
</li>
<li>
<p>二进制类型：bytea类型，适合存储原始字节数据，例如图片</p>
</li>
<li>
<p>日期与时间类型</p>
</li>
<li>
<ul>
<li>date：日期，4字节</li>
<li>time：时间，8字节，带时区12字节</li>
<li>timestamp：带不带时区都8字节。以2000年1月1日0点之前或之后的秒数存储。</li>
<li>interval ：12字节，时间间隔，用于日期时间加减计算等。</li>
<li>时区设置：select timestamp with time zone ‘2025-11-20 06:30:45 PST’</li>
</ul>
</li>
<li>
<p>其他类型：枚举、几何、网络地址、数组、符合类型、xml、range、伪类等</p>
</li>
</ul>
<p>(补充)JSON类型</p>
<ul>
<li>json：数据原封不动存放至数据库、使用时再解析。保留json串中key的顺序，重复key仅保留最后一个。</li>
<li>jsonb：存储时将json转换为二进制格式，使用时无需解析，且支持建索引，使用性能更高。不保留多余空格、不保留key顺序和重复key</li>
</ul>
<p>json类型操作</p>
<p>select ‘[1,2,3]’::json-&gt;2 out:3</p>
<p>select ‘{“a”:1,“b”:2}’::json -&gt;&gt;‘a’ out：1</p>
<p>select ‘{“a”:{“b”:{“c”:1}}}’::json #&gt;‘{a,b}’ out：{“c”:1}</p>
<p>-&gt;和-&gt;&gt;的区别：-&gt;返回原类型，-&gt;&gt;返回转换后的text类型</p>
<p>jsonb ‘[1,2]’ = jsonb ‘[1,2]’ 检测json对象内容一致性</p>
<p>@&gt; 左包含</p>
<p>@&lt; 右包含</p>
<p>? 检测key是否存在</p>
<p>?| 检测数组中是否有任意字符串存在于json的key中</p>
<p>?&amp; 检测数组中是否所有字符串存在于json的key中</p>
<p>jsonb索引</p>
<p>jsonb支持BTree和GIN索引，默认是GIN索引，因为BTree效率相对较低，不关心jsonb内部数据类型，仅简单按整个jsonb大小方式进行排序。</p>
<h2 id="数据类型转换"><a class="markdownIt-Anchor" href="#数据类型转换"></a> 数据类型转换</h2>
<figure class="highlight postgresql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs postgresql"><span class="hljs-number">1</span>、CAST()函数<br><span class="hljs-keyword">select</span> cast(<span class="hljs-string">&#x27;5&#x27;</span> <span class="hljs-keyword">as</span> <span class="hljs-type">int</span>)<br><br><span class="hljs-number">2</span>、::双冒号转换<br><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;10&#x27;</span>::<span class="hljs-type">int</span><br></code></pre></td></tr></table></figure>
<h2 id="常用函数"><a class="markdownIt-Anchor" href="#常用函数"></a> 常用函数</h2>
<figure class="highlight postgresql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs postgresql"><span class="hljs-built_in">current_date</span>、<span class="hljs-built_in">current_timestamp</span><br>当前日期、时间戳<br><br><br><br>now()<br>返回当前时间戳（带时区）<br><br><br>extract()、date_part() //二者等效<br>从日期/时间中抽取子域，返回double precision类型数据。可返回年份/季度/月份/第几个星期/第几天/时/分/秒等。<br>select extract(dom <span class="hljs-keyword">from</span> now()) //获取当前时间是星期几<br><br><br><br>复合类型添加、新增用法<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">type</span> zyl <span class="hljs-keyword">as</span> ( // 创建复合类型<br>z <span class="hljs-type">int</span>,<br>y <span class="hljs-type">double</span> <span class="hljs-type">precision</span>,<br>l <span class="hljs-type">timestamp</span><br>)<br><br><br>//新增复合类型新增数据，可单独为某个字段赋值，未标注的默认为<span class="hljs-keyword">NULL</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> zhouyinglin <span class="hljs-keyword">values</span>(<span class="hljs-keyword">row</span>(<span class="hljs-number">10</span>,<span class="hljs-number">10.00</span>,now()),<span class="hljs-string">&#x27;zyl&#x27;</span>,now())<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> zhouyinglin (zhou.z,ying,lin) <span class="hljs-keyword">values</span>(<span class="hljs-number">100</span>,<span class="hljs-string">&#x27;zyl3&#x27;</span>,now())<br><br><br>//查询复合类型，使用括号隔开列名<br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> zhouyinglin <span class="hljs-keyword">where</span> (zhou).z=<span class="hljs-number">10</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> zhouyinglin <span class="hljs-keyword">where</span> (zhouyinglin.zhou).z=<span class="hljs-number">10</span><br><br><br>//修改复合类型<br><span class="hljs-keyword">update</span> zhouyinglin <span class="hljs-keyword">set</span> zhou=<span class="hljs-keyword">row</span>(<span class="hljs-number">10</span>,<span class="hljs-number">10.00</span>,now()) <span class="hljs-keyword">where</span> (zhou).z=<span class="hljs-number">10</span><br><span class="hljs-keyword">update</span> zhouyinglin <span class="hljs-keyword">set</span> zhou.z=<span class="hljs-number">50.00</span> <span class="hljs-keyword">where</span> (zhou).z=<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>
<h2 id="执行计划"><a class="markdownIt-Anchor" href="#执行计划"></a> 执行计划</h2>
<p>查看执行计划：explain analyze verbose select …</p>
<ul>
<li>
<p>explain：显示查询计划</p>
</li>
<li>
<ul>
<li>执行计划节点：计划由多个操作节点组成，例如Seq Scan、Index Scan、Hash Scan、Sort等。</li>
<li>树形结构：节点以树的形式组织，数据从叶子结点流向根节点。</li>
</ul>
</li>
<li>
<p>analyze：实际执行该查询，收集每个步骤详细的运行时间、返回的行数等</p>
</li>
<li>
<ul>
<li>Actual Time：该节点实际执行时间（毫秒）</li>
<li>Rows：该节点实际返回的行数</li>
<li>Loops：该节点被执行的次数（嵌套循环中可能会执行多次）</li>
</ul>
</li>
<li>
<p>verbose：输出修饰符，展示比explain、analyze更详细的信息</p>
</li>
<li>
<ul>
<li>输出列表：显示每个节点输出的列名</li>
<li>模式限定：表名以schema.table的形式显示</li>
<li>表达式计算：如果查询中有表达式，会显示详细求值信息</li>
</ul>
</li>
</ul>
<p>举例：</p>
<p>cost 后面包含2个数字，用…分开，309.00表示启动成本，即返回第一行需要的cost值，第二个数字表示返回所有数据的成本</p>
<p>rows=9102表示一共返回9120行数据</p>
<p>width=36表示每行平均宽度约36字节。这个数字乘以行数可以估算出总查询量的大小，即36x9102=327672字节≈327KB。</p>
<p>Seq Scan：全表扫描，将表中所有数据块从头到尾读一遍，再从其中找到符合条件的数据块</p>
<p>NestLoop Join：嵌套循环连接，最普通的连接方式。执行过程：确定一个驱动表和一个Inner Table，驱动表每行与Inner Table记录Join一个嵌套循环。注意，join顺序很重要，因此驱动表最好要比较小。（INNER JOIN下，驱动表由优化器判断谁是小表，LEFT JOIN时强制join左边的表为驱动表）</p>
<p>Bitmap Index Scan：扫描索引，将满足条件的行或块在内存中建一个位图，扫描完后根据位图的数据文件把相应的数据读出来，若走多个索引，则将多个位图做 AND或OR计算合并成一个，再找出数据。当执行计划的结果行数很多时可能会走这种扫描，例如in 、非等值查询等。</p>
<p>Hash Join：散列连接，在2表中较小表上建立散列表（前提是小表够放在内存中），然后扫描较大表并探测散列表，找出散列匹配的行。通过pg_relation_size()函数查看表大小</p>
<p>Filter：条件过滤，即where子句上加过滤条件，如果条件列有索引，可能会走索引而不走条件过滤。</p>
<p>Merge Join：合并连接，两表均有索引时(已排序)，合并连接效果可能优于散列连接。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">explain select a.id,b.note <span class="hljs-keyword">from</span> testtab01 a,testtab02 b where a.<span class="hljs-attribute">id</span>=b.id;<br>                                 QUERY PLAN                                  <br>-----------------------------------------------------------------------------<br>  Hash Join  (<span class="hljs-attribute">cost</span>=309.00..701.57 <span class="hljs-attribute">rows</span>=9102 <span class="hljs-attribute">width</span>=36)<br>    Hash Cond: (b.id = a.id)<br>    -&gt;  Seq Scan on testtab02 b  (<span class="hljs-attribute">cost</span>=0.00..165.02 <span class="hljs-attribute">rows</span>=9102 <span class="hljs-attribute">width</span>=36)<br>    -&gt;  Hash  (<span class="hljs-attribute">cost</span>=184.00..184.00 <span class="hljs-attribute">rows</span>=10000 <span class="hljs-attribute">width</span>=4)<br>      -&gt;  Seq Scan on testtab01 a  (<span class="hljs-attribute">cost</span>=0.00..184.00 <span class="hljs-attribute">rows</span>=10000 <span class="hljs-attribute">width</span>=4)<br>(5 rows)<br></code></pre></td></tr></table></figure>
<h2 id="表逻辑结构"><a class="markdownIt-Anchor" href="#表逻辑结构"></a> 表逻辑结构</h2>
<p>数据库服务&gt;数据库&gt;表/索引&gt;行</p>
<p>模式：数据库的一个命名空间或目录，不同模式下可以有相同的表、函数等对象，而不会冲突。模式提出主要用于方便管理。在PG库中，不能同时访问不同数据库对象，但可以访问不同模式间的对象。类似Mysql中的不同的Database。类似Linkdo开发环境中，将linkdo和linkdoapi放在同一个库的不同模式下。</p>
<p>pg在新建一个新数据库时，会默认创建一个public模式登录数据库后，若没有指定，则默认访问public模式内的对象。</p>
<p>新建模式：create schema xxx</p>
<p>模式授权给用户：GRANT USAGE ON SCHEMA {schema_name} TO {username};</p>
<h3 id="pg表的toast技术"><a class="markdownIt-Anchor" href="#pg表的toast技术"></a> PG表的TOAST技术</h3>
<p>TOAST技术主要用于存储大字段的值，由于PG页面大小固定且不允许行跨越多个页面，所以不能直接存储较大的值，转而压缩或者拆分到系统表，即TOAST表。只有变长的数据类型才支持TOAST，变长数据类型中，前4字节（即32bit）成为长度字，长度字的高2bit是标志位，后30bit是长度值，对应1GB。2bit标志位分别对应【压缩标记位】和【是否行外存储】，不论是否压缩、是否行外存储，长度字内的30bit都表示数据的实际尺寸，而不是压缩后的数据长度。</p>
<ul>
<li>压缩标记位：设置后，使用前需要先解压缩</li>
<li>行外存储：设置后，30bit长度位后面只是一个指针</li>
</ul>
<p>修改字段设置</p>
<p>ALTER TABLE blog ALTER content SET STORAGE EXTERNAL;</p>
<p>如果表里有任意字段是支持TOAST的，那么就会自动为该表创建一个关联的TOAST表，行位内容就保存在这个表中。</p>
<h3 id="toast策略"><a class="markdownIt-Anchor" href="#toast策略"></a> TOAST策略</h3>
<ul>
<li>PLAIN：避免压缩、行外存储</li>
<li>EXTENDED：允许压缩和行外存储，优先压缩、后行外存储</li>
<li>EXTERNAL：允许行外存储、不允许压缩</li>
<li>MAIN：允许压缩、不允许行外存储</li>
</ul>
<p>PostgreSQL11之后，可通过参数toast_tuple_target 来控制TOAST触发时机，单行数据在INSERT或UPDATE时，如果超过指定数值，就会将该行数据改为TOAST存储。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams">alter <span class="hljs-keyword">table</span> test01 <span class="hljs-comment">set (toast_tuple_terget=128)</span>; //<span class="hljs-comment">128</span>单位为字节<br></code></pre></td></tr></table></figure>
<p>toast_tuple_terget属于单行优化存储。另外，还可以通过fillfactor、toast.filltactor来控制数据更新时数据块扩展时机。</p>
<p>fillfactor：当前表的填充因子</p>
<p>toast.fillfactor：当前表对应的toast表的填充因子</p>
<p>填充因子取值：10~100，表示数据块在当前页(page)INSERT多少之后就不再继续填充了，仅保留做UPDATE使用。例如设置60，则剩下40只当做UPDATE使用。</p>
<h3 id="补充postgresql的update流程"><a class="markdownIt-Anchor" href="#补充postgresql的update流程"></a> 补充：PostgreSQL的UPDATE流程</h3>
<p>PG在操作UPDATE时，原数据行并不会被覆盖，而是会插入一条新数据行，由于新数据行仍在当前页，因此可以通过Heap-Only Tuple在原行和新行之间建立一个链表，因此UPDATE后不需要重新建索引，索引仍会指向原行，并通过链表找到最新行。</p>
<p>问题：如果UPDATE插入到其他页，则无法使用HOT，这时需要更新表上全部索引，会产生较大的开销。因此，对于更新频繁的表，需要设置一个较小的fillfactor值。</p>
<p>而Linkdo最常更新的linkdo_task_instance表，通过查询系统目录信息并没有查到相关fillfactor配置，而是更加激进的配置：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span> reloptions <span class="hljs-keyword">AS</span> table_options <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">&#x27;linkdo_task_instance&#x27;</span>;<br><br>[&quot;autovacuum_vacuum_scale_factor=0.02&quot;,&quot;autocvacuum_analyze_scale_factor=0.01&quot;]<br></code></pre></td></tr></table></figure>
<ul>
<li>autovacuum_vacuum_scale_factor=0.02：当表中有 2% 的行被更新或删除时触发 vacuum（默认是 20%，即0.2）</li>
<li>autovacuum_analyze_scale_factor=0.01：当表中有 1% 的行被更改时触发 analyze（默认是 10%。即0.1）</li>
</ul>
<h3 id="补充vacuum和analyze"><a class="markdownIt-Anchor" href="#补充vacuum和analyze"></a> 补充：vacuum和analyze</h3>
<p>vacuum是PG库中的空间清理工，用于：清理死元祖、更新可见性地图等，analyze负责查询优化，主要用于收集表的行数、页数，每个列的数值分布、最常见值、更新系统目录。如果没有这些信息，优化器可能会选择很差的查询计划。</p>
<p>[数据变更] → [产生死元组] → [VACUUM清理] → [空间重用]</p>
<p>↓</p>
<p>[统计信息过时] → [ANALYZE更新] → [优化器获得新信息]</p>
<p>临时表</p>
<p>PG库中临时表有2种，一种是单纯的临时表，另一种是半持久化表。</p>
<ul>
<li>
<p>临时表：</p>
</li>
<li>
<ul>
<li>会话级临时表：数据保存在整个会话中</li>
<li>事务级临时表：数据保存在整个事务中</li>
</ul>
</li>
<li>
<p>UNLOGGED表：不产生WAL日志、数据库异常则数据丢失，正常重启不会丢失数据。在使用上与其他表没有差异</p>
</li>
</ul>
<p>创建临时表如下4种写法效果一致</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">create TEMPORARY table tmp<span class="hljs-constructor">_t1(<span class="hljs-params">id</span> <span class="hljs-params">int</span> <span class="hljs-params">primary</span> <span class="hljs-params">key</span>, <span class="hljs-params">note</span> <span class="hljs-params">text</span>)</span>;<br>create TEMP table tmp<span class="hljs-constructor">_t1(<span class="hljs-params">id</span> <span class="hljs-params">int</span> <span class="hljs-params">primary</span> <span class="hljs-params">key</span>, <span class="hljs-params">notes</span> <span class="hljs-params">text</span>)</span><br>create GLOBAL TEMPORARY table tmp<span class="hljs-constructor">_t1(<span class="hljs-params">id</span> <span class="hljs-params">int</span> <span class="hljs-params">primary</span> <span class="hljs-params">key</span>, <span class="hljs-params">note</span> <span class="hljs-params">text</span>)</span>;<br>create LOCAL TEMPORARY table tmp<span class="hljs-constructor">_t1(<span class="hljs-params">id</span> <span class="hljs-params">int</span> <span class="hljs-params">primary</span> <span class="hljs-params">key</span>, <span class="hljs-params">note</span> <span class="hljs-params">text</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>创建unlogged表</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNLOGGED</span> <span class="hljs-keyword">TABLE</span> unlogged01(id <span class="hljs-type">int</span> <span class="hljs-keyword">primary key</span>, t <span class="hljs-type">text</span>);<br></code></pre></td></tr></table></figure>
<h3 id="约束"><a class="markdownIt-Anchor" href="#约束"></a> 约束</h3>
<p>检查约束/非空约束/唯一约束/主键约束/外键约束</p>
<h3 id="修改表"><a class="markdownIt-Anchor" href="#修改表"></a> 修改表</h3>
<p>增删字段</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> <span class="hljs-built_in">column_name</span> <span class="hljs-keyword">type</span>;<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> column_nmae;<br></code></pre></td></tr></table></figure>
<p>增删约束</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">check</span>(age &gt; <span class="hljs-number">16</span>)  //设置检查约束<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-built_in">column_name</span>  <span class="hljs-keyword">set</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> //设置非空约束<br><br>//删除约束前需要知道约束名称是什么<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">constraint</span> <span class="hljs-built_in">constraint_name</span> <br><br>//非空约束没有名字，通过如下语法删除<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> student <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> student_name <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;<br></code></pre></td></tr></table></figure>
<p>修改/删除默认值</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 修改只影响后续<span class="hljs-keyword">INSERT</span>的默认值<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-built_in">column_name</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">default</span> <span class="hljs-number">15</span>;<br><br>// 删除默认值，即将默认值修改为<span class="hljs-keyword">NULL</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-built_in">column_name</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">default</span>;<br></code></pre></td></tr></table></figure>
<p>修改字段数据类型</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 只有字段内所有项都可以隐式转换为新类型时，才能修改字段类型，无法隐式转换则会修改失败<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-built_in">column_name</span> <span class="hljs-keyword">type</span> <span class="hljs-type">text</span>;<br></code></pre></td></tr></table></figure>
<p>字段/表重命名</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">rename</span> <span class="hljs-keyword">column</span> age <span class="hljs-keyword">to</span> age_num; //重命名字段<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-built_in">table_name</span> <span class="hljs-keyword">rename</span> <span class="hljs-keyword">to</span> table_name2; //改表明<br></code></pre></td></tr></table></figure>
<h3 id="继承表"><a class="markdownIt-Anchor" href="#继承表"></a> 继承表</h3>
<p>pg库的表是允许继承的，且允许多继承，继承表的特性如下：</p>
<ul>
<li>子表插入/更新数据后对父表可见，父表插入/更新数据后对子表不可见</li>
<li>如果只想查询父表可使用关键字【only】</li>
<li>父表所有检查约束、非空约束都会自动继承给子表，其他约束不会继承</li>
<li>子表继承父表后，子表拥有所有父表字段总和，类型相同的字段会被融合，融合字段同样继承约束。</li>
</ul>
<h3 id="基于继承表的分区表"><a class="markdownIt-Anchor" href="#基于继承表的分区表"></a> 基于继承表的分区表</h3>
<p>PG库在版本10之前均通过表继承实现分区表，而10之后提供了DDL语句创建声明式分区表，但原理仍然是表继承。表分区就是逻辑上把一个大表分割成物理上的几块，表继承的优势在于：</p>
<ul>
<li>查询、删除更新等操作性能提升，避免全表扫描</li>
<li>访问较少的历史数据可以使用表空间技术移动到便宜的慢速存储介质上</li>
</ul>
<p>创建分区表步骤</p>
<p>1、创建父表，配置好字段。父表不插入数据、不定义约束。</p>
<p>2、创建子表，继承父表字段且不新增字段，自定定义约束，通过关键字段来控制分区，并为关键字段创建索引。</p>
<p>3、定义一个触发器，将原本插入主表的数据重定向到合适的分区表</p>
<p>4、检查constraint_exclusion配置是打开的，打开后查询时如果条件与分区字段匹配，则只查匹配的分区。如果设置为off，则会扫描每张分区子表。</p>
<p>核心配置代码：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_2023 (<br>    <span class="hljs-keyword">CHECK</span> (order_date &gt;= <span class="hljs-string">&#x27;2023-01-01&#x27;</span> <span class="hljs-keyword">AND</span> order_date &lt; <span class="hljs-string">&#x27;2024-01-01&#x27;</span>)<br>) <span class="hljs-keyword">INHERITS</span> (orders); //子表继承父表orders，并为order_date字段添加约束<br><br><br>// 为关键字段添加索引<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_orders_2023_date <span class="hljs-keyword">ON</span> orders_2023 (order_date); <br><br><br>// 触发器代码，配置路由分配<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> orders_insert_trigger()<br><span class="hljs-keyword">RETURNS</span> <span class="hljs-type">TRIGGER</span> <span class="hljs-keyword">AS</span> $$<span class="language-pgsql"></span><br><span class="language-pgsql"><span class="hljs-keyword">BEGIN</span></span><br><span class="language-pgsql">    <span class="hljs-keyword">IF</span> <span class="hljs-built_in">NEW</span>.order_date &gt;= <span class="hljs-string">&#x27;2023-01-01&#x27;</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">NEW</span>.order_date &lt; <span class="hljs-string">&#x27;2024-01-01&#x27;</span> <span class="hljs-keyword">THEN</span></span><br><span class="language-pgsql">        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders_2023 <span class="hljs-keyword">VALUES</span> (<span class="hljs-built_in">NEW</span>.*);  <span class="hljs-comment">-- 插入 2023 年分区</span></span><br><span class="language-pgsql">    <span class="hljs-keyword">ELSIF</span> <span class="hljs-built_in">NEW</span>.order_date &gt;= <span class="hljs-string">&#x27;2024-01-01&#x27;</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">NEW</span>.order_date &lt; <span class="hljs-string">&#x27;2025-01-01&#x27;</span> <span class="hljs-keyword">THEN</span></span><br><span class="language-pgsql">        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders_2024 <span class="hljs-keyword">VALUES</span> (<span class="hljs-built_in">NEW</span>.*);  <span class="hljs-comment">-- 插入 2024 年分区</span></span><br><span class="language-pgsql">    <span class="hljs-keyword">ELSE</span></span><br><span class="language-pgsql">        <span class="hljs-comment">-- 无匹配分区时抛出异常（避免数据插入父表）</span></span><br><span class="language-pgsql">        <span class="hljs-keyword">RAISE</span> <span class="hljs-keyword">EXCEPTION</span> <span class="hljs-string">&#x27;订单日期 % 无对应的分区表&#x27;</span>, <span class="hljs-built_in">NEW</span>.order_date;</span><br><span class="language-pgsql">    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;</span><br><span class="language-pgsql">    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NULL</span>;  <span class="hljs-comment">-- 父表不存储数据，返回 NULL 即可</span></span><br><span class="language-pgsql"><span class="hljs-keyword">END</span>;</span><br><span class="language-pgsql">$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;<br><br><br>// 触发器关联关联<span class="hljs-keyword">order</span>表，并设置触发逻辑<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> trigger_orders_insert<br><span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> orders  <span class="hljs-comment">-- 插入前触发（拦截插入，重定向）</span><br><span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>  <span class="hljs-comment">-- 每行数据都触发一次（行级触发器）</span><br><span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> orders_insert_trigger();<br></code></pre></td></tr></table></figure>
<h3 id="触发器"><a class="markdownIt-Anchor" href="#触发器"></a> 触发器</h3>
<p>由事件自动触发执行的特殊存储过程，触发事件可以是对一个表进行DML操作，一般用于加强数据的完整性约束和业务规则上的约束。格式如下：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">CREATE</span> [ CONSTRAINT ] TRIGGER name <span class="hljs-comment">&#123; BEFORE | AFTER | INSTEAD OF &#125;</span> <span class="hljs-comment">&#123; event [ OR ... ] &#125;</span><br>  <span class="hljs-keyword">ON</span> table_name<br>  [ <span class="hljs-keyword">FROM</span> referenced_table_name ]<br>  <span class="hljs-comment">&#123; NOT DEFERRABLE | [ DEFERRABLE ] &#123; INITIALLY IMMEDIATE | INITIALLY DEFERRED &#125;</span> &#125;<br>  [ <span class="hljs-keyword">FOR</span> [ <span class="hljs-keyword">EACH</span> ] <span class="hljs-comment">&#123; ROW | STATEMENT &#125;</span> ]<br>  [ WHEN ( condition ) ]<br>  EXECUTE <span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title function_">function_name</span> <span class="hljs-params">( arguments )</span><br></code></pre></td></tr></table></figure>
<p>例如，在删除student表数据之后，将score表相关联的数据也删除：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 触发器执行函数<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> student_delete_trigger()<br><span class="hljs-keyword">RETURNS</span> <span class="hljs-type">TRIGGER</span> <span class="hljs-keyword">AS</span> $$<span class="language-pgsql"></span><br><span class="language-pgsql"><span class="hljs-keyword">BEGIN</span></span><br><span class="language-pgsql">  <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> score <span class="hljs-keyword">WHERE</span> student_no = <span class="hljs-built_in">OLD</span>.student_no;</span><br><span class="language-pgsql">  <span class="hljs-keyword">RETURN</span> <span class="hljs-built_in">OLD</span>;</span><br><span class="language-pgsql"><span class="hljs-keyword">END</span>;</span><br><span class="language-pgsql">$$</span><br><span class="hljs-keyword">LANGUAGE</span> plpgsql;<br><br>// 新建触发器<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> delete_student_trigger<br>  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">DELETE</span>  <span class="hljs-keyword">ON</span> student<br>  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> student_delete_trigger ();<br></code></pre></td></tr></table></figure>
<ul>
<li>语句级触发器：执行每个SQL语句时，只执行一次，实际操作0行的语句仍有可能被触发。</li>
<li>行级触发器：执行每行SQL语句都会执行一次，实际操作0行的语句不会被触发</li>
</ul>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> log_student_trigger ()<br><span class="hljs-keyword">RETURNS</span> <span class="hljs-type">trigger</span> <span class="hljs-keyword">AS</span><br>$$<span class="language-pgsql"></span><br><span class="language-pgsql"><span class="hljs-keyword">BEGIN</span></span><br><span class="language-pgsql">    // <span class="hljs-built_in">TG_OP</span>是触发器函数中的特殊变量，表示DML操作</span><br><span class="language-pgsql">  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> log_student <span class="hljs-keyword">values</span>(now(), <span class="hljs-keyword">user</span>, <span class="hljs-built_in">TG_OP</span>);</span><br><span class="language-pgsql">  <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NULL</span>;</span><br><span class="language-pgsql"><span class="hljs-keyword">END</span>;</span><br><span class="language-pgsql">$$</span><br><span class="hljs-keyword">LANGUAGE</span> &quot;plpgsql&quot;;<br></code></pre></td></tr></table></figure>
<ul>
<li>BEFORE触发器：语句开始做任何事情之前被触发</li>
<li>AFTER触发器：：语句结束时触发</li>
</ul>
<p>before和after属于触发器的触发时机，可以用在行级，也可以用于语句级。如果既有行级、也有语句级，那么行级的after会早于语句级after执行。</p>
<p>删除触发器</p>
<p>删除一个触发器使用的语法是drop trigger xxx on table，当删除触发器时，触发器函数本身并不会被删除。完整语法如下：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TRIGGER</span> [ <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> ] <span class="hljs-type">name</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">table</span> [ <span class="hljs-keyword">CASCADE</span> | <span class="hljs-keyword">RESTRICT</span> ];<br></code></pre></td></tr></table></figure>
<ul>
<li>IF EXESTS：如果要删除的触发器不存在，提出一个notice而不报错</li>
<li>CASCADE：级联删除依赖此触发器的对象</li>
<li>RESTRICT：默认值，有依赖对象就拒绝删除</li>
</ul>
<h3 id="表空间"><a class="markdownIt-Anchor" href="#表空间"></a> 表空间</h3>
<p>PostgreSQL中的表空间，实际上是为表指定一个存储目录，在创建数据库、创建表、索引、唯一约束、主键约束的时候均可以指定表空间。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">// 通过<span class="hljs-keyword">create</span> <span class="hljs-keyword">tablespace</span> xxx <span class="hljs-keyword">location</span>关键字实现新建表空间<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLESPACE</span> tbs_data <span class="hljs-keyword">location</span> <span class="hljs-string">&#x27;/data/pgdata&#x27;</span>; <br><br>//创建数据库时指定表空间，后续的表、索引等都会放这个目录下<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> db01 <span class="hljs-keyword">tablespace</span> tbs_data;<br></code></pre></td></tr></table></figure>
<h2 id="视图"><a class="markdownIt-Anchor" href="#视图"></a> 视图</h2>
<p>新增视图</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">CREATE</span> [ <span class="hljs-keyword">OR</span> REPLACE ] [ TEMP | TEMPORARY ] VIEW name [ ( column_name [, ...] ) ]<br>  <span class="hljs-keyword">AS</span> query <br><br><span class="hljs-comment">// 将原表中的字段名重命名</span><br><span class="hljs-keyword">CREATE</span> VIEW vw_users(no, name,email, mark)  <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> id, user_name, user_email, user_mark <span class="hljs-keyword">FROM</span> users<span class="hljs-punctuation">;</span><br><br><span class="hljs-comment">// 通过设置触发器来实现视图更新，每次INSERT、UPDATE、DELETE,都会触发insert到视图</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> <span class="hljs-title function_">vw_users_insert_trigger</span><span class="hljs-params">()</span><br><span class="hljs-title function_">RETURNS</span> <span class="hljs-title function_">TRIGGER</span> <span class="hljs-title function_">AS</span> $$<br><span class="hljs-title function_">BEGIN</span><br>  <span class="hljs-title function_">INSERT</span> <span class="hljs-title function_">INTO</span> <span class="hljs-title function_">users</span> <span class="hljs-title function_">VALUES</span><span class="hljs-params">(<span class="hljs-keyword">NEW</span>.id, <span class="hljs-keyword">NEW</span>.user_name,<span class="hljs-string">&#x27;111111&#x27;</span>, <span class="hljs-keyword">NEW</span>.user_email, <span class="hljs-keyword">NEW</span>.user_mark)</span>;<br>  RETURN NULL<span class="hljs-punctuation">;</span><br><span class="hljs-keyword">END</span><span class="hljs-punctuation">;</span><br>$$<br>LANGUAGE plpgsql<span class="hljs-punctuation">;</span><br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> <span class="hljs-title function_">vw_users_update_trigger</span><span class="hljs-params">()</span><br><span class="hljs-title function_">RETURNS</span> <span class="hljs-title function_">TRIGGER</span> <span class="hljs-title function_">AS</span> $$<br><span class="hljs-title function_">BEGIN</span><br>  <span class="hljs-title function_">UPDATE</span> <span class="hljs-title function_">users</span> <span class="hljs-title function_">SET</span> <span class="hljs-title function_">user_email</span> = <span class="hljs-title function_">NEW</span>.<span class="hljs-title function_">user_email</span> <span class="hljs-title function_">WHERE</span> <span class="hljs-title function_">id</span>= <span class="hljs-title function_">NEW</span>.<span class="hljs-title function_">id</span>;<br>  RETURN NULL<span class="hljs-punctuation">;</span><br><span class="hljs-keyword">END</span><span class="hljs-punctuation">;</span><br>$$<br>LANGUAGE plpgsql<span class="hljs-punctuation">;</span><br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> <span class="hljs-title function_">vw_users_delete_trigger</span><span class="hljs-params">()</span><br><span class="hljs-title function_">RETURNS</span> <span class="hljs-title function_">TRIGGER</span> <span class="hljs-title function_">AS</span> $$<br><span class="hljs-title function_">BEGIN</span><br>  <span class="hljs-title function_">DELETE</span> <span class="hljs-title function_">FROM</span>  <span class="hljs-title function_">users</span> <span class="hljs-title function_">WHERE</span> <span class="hljs-title function_">id</span>= <span class="hljs-title function_">NEW</span>.<span class="hljs-title function_">id</span>;<br>  RETURN NULL<span class="hljs-punctuation">;</span><br><span class="hljs-keyword">END</span><span class="hljs-punctuation">;</span><br>$$<br>LANGUAGE plpgsql<span class="hljs-punctuation">;</span><br><br><span class="hljs-keyword">CREATE</span> TRIGGER insert_vw_users_trigger<br>  INSTEAD <span class="hljs-keyword">OF</span> INSERT <span class="hljs-keyword">ON</span> vw_users<br>  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> ROW EXECUTE <span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title function_">vw_users_insert_trigger</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">CREATE</span> TRIGGER update_vw_users_trigger<br>  INSTEAD <span class="hljs-keyword">OF</span> UPDATE <span class="hljs-keyword">ON</span> vw_users<br>  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> ROW EXECUTE <span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title function_">vw_users_update_trigger</span><span class="hljs-params">()</span>;<br><br><span class="hljs-keyword">CREATE</span> TRIGGER delete_vw_users_trigger<br>  INSTEAD <span class="hljs-keyword">OF</span> DELETE <span class="hljs-keyword">ON</span> vw_users<br>  <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> ROW EXECUTE <span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title function_">vw_users_delete_trigger</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>
<ul>
<li>TEMP/TEMPORARY：临时视图，session结束后该视图消失</li>
</ul>
<h2 id="索引"><a class="markdownIt-Anchor" href="#索引"></a> 索引</h2>
<p>索引用于快速查询数据，它记录了表中的一列或者多列值与其物理位置之间的对应关系。</p>
<ul>
<li>优点：加快对表中记录的查询和排序</li>
<li>缺点：额外增加数据库存储空间、插入修改数据时更新索引需要时间</li>
</ul>
<p>索引种类</p>
<ul>
<li>Btree：最常用索引，也是默认索引类型。B表示平衡balanced，表示树的各个分叉的数据量大致相等。主要适用于处理等值查询和范围查询</li>
<li>HASH：只能处理等值查询，当索引键是较长字符串时，索引占用空间较大，哈希索引占空间小。</li>
<li>GiST、SP-GiST：通用搜索树，非单独一种索引，是一种架构，基于该架构可以实现不同的索引策略</li>
<li>GIN：通用逆向索引，可以处理包含多个键的值，如数组，同样是一种架构。PG的全文检索用的就是GIN索引</li>
</ul>
<p>新建索引</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">CREATE</span> [ UNIQUE ] <span class="hljs-keyword">INDEX</span> [ CONCURRENTLY ] [ name ] <span class="hljs-keyword">ON</span> table_name [ <span class="hljs-keyword">USING</span> <span class="hljs-keyword">method</span> ]<br>  <span class="hljs-params">( &#123; column_name | ( expression )</span> &#125; [ <span class="hljs-title function_">COLLATE</span> <span class="hljs-title function_">collation</span> ] [ <span class="hljs-title function_">opclass</span> ] [ <span class="hljs-title function_">ASC</span> | <span class="hljs-title function_">DESC</span> ] [ <span class="hljs-title function_">NULLS</span> <span class="hljs-comment">&#123; FIRST | LAST &#125;</span> ] [, ...] )<br>  [ <span class="hljs-title function_">WITH</span> <span class="hljs-params">( storage_parameter = value [, ... ] )</span> ]<br>  [ <span class="hljs-title function_">TABLESPACE</span> <span class="hljs-title function_">tablespace_name</span> ]<br>  [ <span class="hljs-title function_">WHERE</span> <span class="hljs-title function_">predicate</span> ]<br></code></pre></td></tr></table></figure>
<p>UBUQUE：唯一约束</p>
<p>CONCURRENTLY：并发创建，建索引时不锁表，使用在生产环境大表使用</p>
<p>USING method：可选索引算法，默认B树</p>
<p>column_name：索引键，可单列可多列</p>
<p>其他：用的频度较少</p>
<p>（补充）PG库的索引机制——BTree</p>
<p>BTree属于多叉平衡搜索树，每个节点可以拥有多个子节点，相比二叉树，这种结构减少了树的高度，从而减少I/O次数。</p>
<ul>
<li>
<p>平衡：所有叶节点都在同一层</p>
</li>
<li>
<p>有序：节点内有序、任意元素的左子树都小于它，右子树都大于它</p>
</li>
<li>
<p>多路：对于m阶B树的接电：</p>
</li>
<li>
<ul>
<li>最多有m个分支、m-1个元素</li>
<li>根节点最少有2个分支，1各元素、其他节点有m/2个分支，(m/2)-1个元素</li>
</ul>
</li>
</ul>
<p>在使用索引时，访问结点是在硬盘上进行的，而结点内的查找是在内存中进行的。</p>
<p>BTree的插入：</p>
<p>先找到插入的位置进行插入，如果没有上溢出（插入为止一定在叶节点），无需调整。否则中间元素(m/2)上移，两边分裂，直到没有上溢为止。</p>
<h2 id="存储过程"><a class="markdownIt-Anchor" href="#存储过程"></a> 存储过程</h2>
<h3 id="语法"><a class="markdownIt-Anchor" href="#语法"></a> 语法</h3>
<h4 id="变量定义"><a class="markdownIt-Anchor" href="#变量定义"></a> 变量定义</h4>
<ul>
<li>基础变量类型：declare v_num int := 0</li>
<li>列类型变量：v_username user_info.username%TYPE</li>
<li>行变量类型：v_user user_info%ROWTYPE</li>
<li>动态记录类型：v_rec RECODE</li>
</ul>
<h4 id="变量赋值"><a class="markdownIt-Anchor" href="#变量赋值"></a> 变量赋值</h4>
<ul>
<li>直接赋值：v_num:=v_num+1</li>
<li>从查询结果赋值(单值)：select username into v_username from user_info where id=1</li>
<li>从查询结果赋值(整行)：select * into v_user from user_info where id=1</li>
</ul>
<h3 id><a class="markdownIt-Anchor" href="#"></a> </h3>
<h4 id="流程判断"><a class="markdownIt-Anchor" href="#流程判断"></a> 流程判断</h4>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">//<span class="hljs-keyword">if</span>-<span class="hljs-keyword">else</span> 条件判断<br><span class="hljs-keyword">IF</span> v_age &lt; <span class="hljs-number">18</span> <span class="hljs-keyword">THEN</span><br>    p_result := <span class="hljs-string">&#x27;未成年&#x27;</span>;<br><span class="hljs-keyword">ELSIF</span> v_age <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">18</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">60</span> <span class="hljs-keyword">THEN</span><br>    p_result := <span class="hljs-string">&#x27;成年&#x27;</span>;<br><span class="hljs-keyword">ELSE</span><br>    p_result := <span class="hljs-string">&#x27;老年&#x27;</span>;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;<br><br>// 多分支<br><span class="hljs-keyword">CASE</span><br>    <span class="hljs-keyword">WHEN</span> v_age &lt; <span class="hljs-number">18</span> <span class="hljs-keyword">THEN</span> p_result := <span class="hljs-string">&#x27;未成年&#x27;</span>;<br>    <span class="hljs-keyword">WHEN</span> v_age <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">18</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">60</span> <span class="hljs-keyword">THEN</span> p_result := <span class="hljs-string">&#x27;成年&#x27;</span>;<br>    <span class="hljs-keyword">ELSE</span> p_result := <span class="hljs-string">&#x27;老年&#x27;</span>;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">CASE</span>;<br><br>// <span class="hljs-keyword">for</span> 循环<br><span class="hljs-keyword">FOR</span> v_user <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> user_info <span class="hljs-keyword">LOOP</span><br>    <span class="hljs-comment">-- 加工数据（示例：年龄+1）</span><br>    v_user.age := v_user.age + <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">-- 返回单条结果</span><br>    <span class="hljs-keyword">RETURN NEXT</span> v_user;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br><br>//<span class="hljs-keyword">while</span> 循环<br><span class="hljs-keyword">WHILE</span> v_i &lt;= <span class="hljs-number">10</span> <span class="hljs-keyword">LOOP</span><br>    v_sum := v_sum + v_i;<br>    v_i := v_i + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;<br></code></pre></td></tr></table></figure>
<h4 id="异常处理"><a class="markdownIt-Anchor" href="#异常处理"></a> 异常处理</h4>
<p>略。</p>
<h2 id="存储结构"><a class="markdownIt-Anchor" href="#存储结构"></a> 存储结构</h2>
<ul>
<li>逻辑结构：数据库簇&gt;数据库&gt;模式&gt;表=视图=索引=函数</li>
<li>物理结构：使用环境变量PGDATA指向数据库目录的根目录，根目录初始化后，会生成一系列配置文件。</li>
</ul>
<p><em><strong>*默认表空间下的存储：*</strong></em></p>
<p>在默认表空间的base目录下的很多子目录，子目录名称与数据库的oid一致。每个子目录下都存放着各自数据库的表、索引文件，每个表和索引都会分配一个文件号relfilennode，数据文件格式以relfilennode.顺序号命名，每个文件最大1GB，当表或索引内容大于1GB时，就会从1开始生成顺序号。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> <span class="hljs-type">oid</span>,datname <span class="hljs-keyword">from</span> pg_database;<br></code></pre></td></tr></table></figure>
<p>自定义表空间下的存储：</p>
<p>当用户自己创建表空间并自定义目录时，会在表空间的根目录下生成带有“CatLog version”的子目录，完整格式为【PG_{pg库大版本号}_{Catalog version}】。在这个目录下，才有数据库oid那些子目录。</p>
<h2 id="调优"><a class="markdownIt-Anchor" href="#调优"></a> 调优</h2>
<p>逻辑结构优化</p>
<p>表优化</p>
<ul>
<li>根据具体情况挑选合适的TOAST策略</li>
<li>调整表的fillfactor参数</li>
<li>使用临时表</li>
<li>使用分区表</li>
<li>使用表空间将不同的表分散放在不同存储介质下</li>
</ul>
<p>索引优化</p>
<ul>
<li>超过300行的表应该需要索引</li>
<li>经常与其他表进行连接的表，在连接字段上应该建索引</li>
<li>经常出现在where子句/group by/order by中的字段，应该建索引</li>
<li>查询很少的列不应该建索引</li>
<li>大字段不建议建索引，或建哈希索引，而不是普通索引</li>
<li>复合索引建立前应考虑清楚，这几个字段是否经常一起使用，是的话可以建，否则建议走单字段索引</li>
<li>不要在符合索引已建立的基础上，再次单独建单个字段的索引</li>
<li>符合索引字段个数应小于等于3个</li>
<li>频繁进行数据操作的表不要建立太多索引</li>
<li>删除无用的索引</li>
<li>索引创建时可以将索引放置在SSD盘的表空间，常规的表数据则放在机械硬盘</li>
</ul>
<p>SQL优化</p>
<ul>
<li>避免全表扫描和排序，考虑在where子句条件字段和排序字段中建立索引</li>
<li>范围查询较多时，通过CLUSTER table_name USING index_name 将存储物理排序与索引顺序一致，减少IO以提高查询效率</li>
<li>避免在where子句中对字段进行函数或表达式操作，这会导致走不到索引</li>
<li>用exists替代in查询</li>
<li>数值信息的字段不要涉及成字符型，且优先使用int和bigint，如果这2个类型范围内不能表示，再用numeic</li>
<li>避免使用select * 返回所有列</li>
<li>尽量多使用表的别名，并将别名前缀于每个列上</li>
<li>适当使用存储过程，减少客户端和数据库的交互次数</li>
<li>COPY导出数据比INSERT和批量INSERT快得多</li>
<li>存储过程中减少使用循环</li>
<li></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Study/" class="category-chain-item">Study</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">#数据库</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PostgreSQL笔记</div>
      <div>https://zhouyinglin.top/post/92053909.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>小周</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月12日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年12月12日</div>
        </div>
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/post/d9ff6a1.html" title="深圳的秋天">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">深圳的秋天</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/post/9feac443.html" title="现代计算机主内存的简单原理（DDR5为例）">
                        <span class="hidden-mobile">现代计算机主内存的简单原理（DDR5为例）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://lib.baomitu.com/waline/2.5.1/waline.min.css')
      Fluid.utils.createScript('https://lib.baomitu.com/waline/2.5.1/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"https://waline-comment-blond.vercel.app/","path":"window.location.pathname","meta":["nick","mail","link"],"login":"enable","lang":"zh-CN","emoji":["https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/bilibili"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
     
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <div id="waline"></div> <script> const locale = { placeholder: "说点什么吧！(填写邮箱可在被回复时收到邮件提醒)", }; Waline.init({ el: "#waline", serverURL: "https://comment.zhouyinglin.cn/", locale, }); </script>
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <link rel="stylesheet" href="/dist/APlayer.min.css"> <div id="aplayer"></div> <script type="text/javascript" src="/dist/APlayer.min.js"></script> <script type="text/javascript" src="/js/amusic.js"></script>  <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div class="statistics" style="font-size: 0.85rem"> <a target="_blank" rel="noopener" href="https://developer.hitokoto.cn/" id="hitokoto_text"><span style="color: #3c4858;"  id="hitokoto"></span></a> <script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script></div>  <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访客量 
        <span id="leancloud-site-pv"></span>
         次 
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总用户量 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>
<div class="statistics">
 	<a target="_blank" rel="noopener" href="https://developer.hitokoto.cn/" id="hitokoto_text"><span style="color: #DDD;"  id="hitokoto"></span></a>
<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>
 </div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="https://unpkg.com/@waline/client@v2/dist/waline.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
